<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Openwrt on 记录点滴 - 分享</title><link>https://konghanghang.github.io/iminling-pages/tags/openwrt/</link><description>Recent content in Openwrt on 记录点滴 - 分享</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>iminling.com</copyright><lastBuildDate>Sun, 24 Mar 2024 05:43:31 +0000</lastBuildDate><atom:link href="https://konghanghang.github.io/iminling-pages/tags/openwrt/index.xml" rel="self" type="application/rss+xml"/><item><title>Proxmox VE(PVE)8.0安装Openwrt实现旁路由模式</title><link>https://konghanghang.github.io/iminling-pages/2024/pve-install-openwrt/</link><pubDate>Sun, 24 Mar 2024 05:43:31 +0000</pubDate><guid>https://konghanghang.github.io/iminling-pages/2024/pve-install-openwrt/</guid><description>&lt;p>在前两篇文章中分别介绍了&lt;a class="link" href="https://www.iminling.com/2024/03/23/459.html" title="畅网J4125安装Proxmox virtual environment(pve) 8.0"
target="_blank" rel="noopener"
>pve的安装&lt;/a>以及pve安装ikuai做为主路由来拨号上网，此时的网络环境基本已经稳定，但出于特殊需求，我需要使用Openwrt来进行科学上网，所以今天就来折腾一下pve安装Openwrt并实现旁路由模式。&lt;/p>
&lt;h2 id="openwrt镜像">openwrt镜像
&lt;/h2>&lt;p>我使用的是&lt;a class="link" href="https://github.com/DHDAXCW/OpenWRT_x86_x64/releases" target="_blank" rel="noopener"
>骷髅头的openwrt&lt;/a>镜像，下载的是beggar版本，可根据自己的需求找不同的openwrt版本。下载完成后需要对文件进行解压，下载下来的是&lt;code>.gz&lt;/code>结尾的文件，需要解压成&lt;code>.img&lt;/code>结尾的文件，解压后上传到pve中&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/BC97614C54342FD608F4DC6371CAC5A2.png"
loading="lazy"
alt="upload iso"
>&lt;/p>
&lt;h2 id="创建">创建
&lt;/h2>&lt;h3 id="常规">常规
&lt;/h3>&lt;p>vm ID默认自增到101(ikuai是100)，名称自己填，我这里填openwrt&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/530BCC51DD19D59BD1FE510D32076904.png"
loading="lazy"
alt="pve openwrt common"
>&lt;/p>
&lt;h3 id="操作系统">操作系统
&lt;/h3>&lt;p>选择不使用任何介质&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/C8D5A323386C9A1DE5B0BB9BE0386666.png"
loading="lazy"
alt="pve openwrt os"
>&lt;/p>
&lt;h3 id="系统">系统
&lt;/h3>&lt;p>全部默认就可以了&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/E821D7E134B98F154E16F7EAC211E8C8.png"
loading="lazy"
alt="pve openwrt os"
>&lt;/p>
&lt;h3 id="磁盘">磁盘
&lt;/h3>&lt;p>这里保持默认，后边会进行删除。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/A26DDB4E4114936B881254ED7A0DF2B1.png"
loading="lazy"
alt="pve openwrt disk"
>&lt;/p>
&lt;h3 id="cpu">CPU
&lt;/h3>&lt;p>同样把j4125的四个核心都给到它&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/837D4B78C94107F0889EC9C53103D241.png"
loading="lazy"
alt="pve openwrt cpu"
>&lt;/p>
&lt;h3 id="内存">内存
&lt;/h3>&lt;p>运行openwrt,1GB的RAM就够用了。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/A7271E4BAEB3BEFE01324962F694F811.png"
loading="lazy"
alt="pve openwrt ram"
>&lt;/p>
&lt;h3 id="网络">网络
&lt;/h3>&lt;p>全部默认&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/5A90B845671AC32312801582885D4C09.png"
loading="lazy"
alt="pve openwrt network"
>&lt;/p>
&lt;h3 id="确认">确认
&lt;/h3>&lt;p>确认所有选项是否正确。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/87FEC65DDEE9CF8BB85FFFFF5B6D8C10.png"
loading="lazy"
alt="pve openwrt summary"
>&lt;/p>
&lt;p>没有问题就点完成。&lt;/p>
&lt;h2 id="硬件配置">硬件配置
&lt;/h2>&lt;p>创建过程中选择的硬盘是需要删除的，所以需要对硬件进行一些配置。&lt;/p>
&lt;h3 id="移除cd">移除CD
&lt;/h3>&lt;p>在硬件配置中将已存在的CD/DVD驱动器移除&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/81E209EBFF4348F0AE3B4E54454553D6.png"
loading="lazy"
alt="pve openwrt remove cd"
>&lt;/p>
&lt;h3 id="分离并移除硬盘">分离并移除硬盘
&lt;/h3>&lt;p>选中硬盘，先进行分离，然后进行移除。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/5894F46E2E267BC2B2E470D46D4C1CE0.png"
loading="lazy"
alt="pve openwrt remove disk"
>&lt;/p>
&lt;p>移除&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/F613F961817AF86518ABE38F0FC5C596.png"
loading="lazy"
alt="pve openwrt remove disk"
>&lt;/p>
&lt;h2 id="添加磁盘">添加磁盘
&lt;/h2>&lt;p>需要通过进入&lt;code>pve的shell&lt;/code>执行命令来导入磁盘,执行命令&lt;code>qm importdisk 虚拟主机编号 /var/lib/vz/template/iso/openwrt镜像名 local-lvm&lt;/code> ，虚拟主机编号是在经过上边创建虚拟机后pve生成的一个编号，例如我的是101，openwrt镜像名是在刚开始的时候上传到pve中的名称，我的名称是：openwrt.img. 替换后的命令如下：&lt;code>qm importdisk 101 /var/lib/vz/template/iso/openwrt.img local-lvm&lt;/code>。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/CC7BD8ADEB55C47A3D661F37295D1213.png"
loading="lazy"
alt="pve openwrt importdisk"
>&lt;/p>
&lt;p>执行成功后会在硬件中看到一个未使用的磁盘，进行添加。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/3B19CC29E51F0933E2F10FCE711C62B4.png"
loading="lazy"
alt="pve openwrt importdisk"
>&lt;/p>
&lt;h3 id="引导顺序">引导顺序
&lt;/h3>&lt;p>磁盘添加后需要修改引导为当前的磁盘&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/3B9F70D8EF2F373E80CB1162B86C7A3E.png"
loading="lazy"
alt="pve openwrt boot sort"
>&lt;/p>
&lt;p>经过上边的设置就已经完全ok了，可以来启动openwrt了。&lt;/p>
&lt;h2 id="openwrt设置">openwrt设置
&lt;/h2>&lt;p>启动openwrt虚拟机，如下会卡住，敲回车就可以进行下去&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/2651DCA4CAEAB2FC8C5B7552D7AFD17B.png"
loading="lazy"
alt="pve openwrt boot"
>&lt;/p>
&lt;p>回车后如下图，表示启动成功&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/3C4703FF7B2FFF4B2100411200448BCA.png"
loading="lazy"
alt="pve openwrt"
>&lt;/p>
&lt;h3 id="设置ip">设置ip
&lt;/h3>&lt;p>一般固件都有自己的管理ip，可能和我们自己的网络不是在同一个网段，比如我下载这个默认的管理网段是192.168.6.1，我需要改成和我的网络在同一个网段，192.168.1.xxx。&lt;/p>
&lt;p>编辑 /etc/config/network，修改如下：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/30305231BD4E418E530C4EFB1F2D2B2F.png"
loading="lazy"
alt="pve openwrt ip"
>&lt;/p>
&lt;p>我这里改成192.168.1.254，修改保存后重启openwrt,重启后就可以通过访问192.168.1.254在浏览器中进行相关配置了。&lt;/p>
&lt;h3 id="lan口设置">LAN口设置
&lt;/h3>&lt;p>进入openwrt系统后，首先是对网络接口LAN口进行设置，设置网关为爱快(ikuai)的管理地址，并关闭LAN口的DHCP功能&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/7F71B9608FB1F3EC02023B3A60FDCD08.png"
loading="lazy"
alt="pve openwrt lan"
>&lt;/p>
&lt;p>修改网关&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/0DC12C48DA49DFC3761270F7C1647457.png"
loading="lazy"
alt="pve openwrt gateway"
>&lt;/p>
&lt;p>这里需要注意一点，我在刚开始设置的时候并没有设置&lt;code>使用自定义DNS服务器&lt;/code>，后边发现openwrt无法上网，最终是填写了一个DNS服务器后才解决的，这里可以使用223.5.5.5或者其他的DNS服务器。&lt;/p>
&lt;h3 id="关闭防火墙">关闭防火墙
&lt;/h3>&lt;p>接下来关闭openwrt的防火墙&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/FD8C04F7DB94CBB12DB8675733828FDA.png"
loading="lazy"
alt="pve openwrt firewall"
>&lt;/p>
&lt;h3 id="upnp">UPNP
&lt;/h3>&lt;p>开启UPNP&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/A69A4758D6648D6D3977B0F2A9552B54.png"
loading="lazy"
alt="pve openwrt upnp"
>&lt;/p>
&lt;p>经过上边的设置，openwrt基本已设置完毕，可以开始使用了。&lt;/p>
&lt;h2 id="旁路由模式">旁路由模式
&lt;/h2>&lt;p>openwrt做为旁路由，该怎么工作呢，在ikuai设置的时候我设置了31-250的一个DHCP网络段，他们只会经过ikuai来处理流量，那什么设备可以经过这个openwrt旁路由呢？这里就需要在ikuai中进行一些设置了，同样是DHCP服务,我设置了10-30这个ip段的ip的网关为&lt;code>192.168.1.254&lt;/code>也就是openwrt的ip，那么这个ip段里的设置的网络就会经过openwrt来处理，满足特定需求了。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/213157C522C8091C348D788D4777FDE0.png"
loading="lazy"
alt="pve openwrt ikuai"
>&lt;/p>
&lt;p>因为我是先设置的31-250这个ip段，所以连接上来的设置被优先往这个ip段分配，自己的其他设置如果想要使用openwrt来处理流量，则对特定设置固定ip就可以了，设置他们的ip在10-30之间。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2024/03/5B2B6D7B677CDC4C07E01EC2ADB813F4.png"
loading="lazy"
alt="pve ikuai dhcp"
>&lt;/p>
&lt;p>大功告成，使用pve安装ikuai并使用openwrt做为旁路由。&lt;/p></description></item><item><title>openwrt系统frps配置使用</title><link>https://konghanghang.github.io/iminling-pages/2023/openwrt-frps-configuration/</link><pubDate>Sun, 09 Apr 2023 06:23:58 +0000</pubDate><guid>https://konghanghang.github.io/iminling-pages/2023/openwrt-frps-configuration/</guid><description>&lt;p>宽带给了公网ip，所以想在自己家搭建一个frp的服务端，这样子就可以当做一台服务器，来进行内网穿透使用了。&lt;/p>
&lt;h2 id="frps配置">frps配置
&lt;/h2>&lt;p>我家里是使用的r2s刷的openwrt系统，所以可以在r2s中进行frps的搭建，找到对应的菜单：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/1681048330252.jpg"
loading="lazy"
>&lt;/p>
&lt;p>端口绑定默认7000，直接使用就可以了，我们这里主要是使用http和https服务，所以填写对应的http和https绑定端口就可以了，可以和端口绑定设置成同一个端口。&lt;/p>
&lt;h2 id="子域名设置">子域名设置
&lt;/h2>&lt;p>在高级选项中我们可以设置一个子域名，这样子我们就可以使用改域名的子域名来进行访问不同的内网穿透服务。对应的子域名下也有一行提示：&lt;/p>
&lt;blockquote>
&lt;p>如果subdomain_host不为空，可以在frpc配置文件中设置类型为http(s)的subdomain；subdomain为test，路由将使用test.frps.com&lt;/p>&lt;/blockquote>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/489b5400b50f60b56447af44a18341ec.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="管理面板设置">管理面板设置
&lt;/h2>&lt;p>我们可以在管理面板查看到当前已经连接的客户端，以及每个客户端的流量使用情况，所以还是有必要进行一下设置。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/a3b4a82854f5665e9121f057d71f80b9.png"
loading="lazy"
>&lt;/p>
&lt;p>面板绑定端口7500，那么我们就可以使用openwrt的管理ip:7500来登录到frps的管理界面。&lt;/p>
&lt;h2 id="端口转发配置">端口转发配置
&lt;/h2>&lt;h3 id="管理界面端口配置">管理界面端口配置
&lt;/h3>&lt;p>我们在家里的时候可以使用内网ip:7500来访问，但是不在家的时候就没办法了。不慌，因为我有公网ip，那么我就可以通过端口转发，使用的域名+特定端口来访问到内网的7500端口。通过网络防火墙进行端口转发配置。&lt;/p>
&lt;p>配置管理界面的端口转发，通过&lt;code>域名:7500&lt;/code>访问到内网openwrt系统的7500端口。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/81b1d5e9cd4cfd2ad84557fa31f8a401.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="绑定端口配置">绑定端口配置
&lt;/h3>&lt;p>我们的frps绑定的端口是7000，所以需要把7000端口也暴露出去客户端才能正常连接注册上来，同样需要在端口转发中进行配置。&lt;/p>
&lt;p>通过&lt;code>域名:7000&lt;/code>访问到内网openwrt系统的7000端口。&lt;/p>
&lt;blockquote>
&lt;p>参考上边的管理界面的端口转发配置。&lt;/p>&lt;/blockquote>
&lt;p>到这里我们的frps服务端就搭建好了，接下来我们来配置客户端进行连接。&lt;/p>
&lt;h2 id="客户端连接">客户端连接
&lt;/h2>&lt;p>我们主要先在需要内网穿透的机器上安装frp的客户端，我这里是一个路由器刷的openwrt系统，所以安装frpc就可以了：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/9c8e8a6e6d4ea5bfcf8d82a288aba913.png"
loading="lazy"
>&lt;/p>
&lt;p>服务器：其实就是我们frps服务端的ip，因为我使用的是宽带的动态ip，所以ip是会变的，我不能直接使用ip，但是我在家里的openwrt中配置了DDNS，那么我就可以使用ddns的域名来作为服务器，填入ddns中的域名。&lt;/p>
&lt;p>端口：7000，和frps的绑定端口一致。&lt;/p>
&lt;p>令牌：和frps中的令牌一致。&lt;/p>
&lt;p>http和https穿透服务端口：7000，和服务端一致。&lt;/p>
&lt;p>经过上边的配置我们就可以和服务端连上了，但是我们还没办法通过公网来访问我们其他需要穿透的服务，我们还需要建一条规则。在下方frp setting页面的下方点击添加，新建一个服务：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/36e2c4682ea0816f2a20b91d2c9af36d.png"
loading="lazy"
>&lt;/p>
&lt;p>开启状态：开启。&lt;/p>
&lt;p>frp协议类型：选择http就可以了。&lt;/p>
&lt;p>域名类型：我们在frps服务端配置的时候使用的是子域名形式，所以这里也需要填子域名。&lt;/p>
&lt;p>子域名：我们需要使用的访问域名。&lt;/p>
&lt;p>内网主机地址：我们需要访问的是openwrt的管理界面，所以选择openwrt的地址就可以了。&lt;/p>
&lt;p>内网主机端口：我们访问的是管理界面，默认80端口。&lt;/p>
&lt;p>服务备注名：自定义的一个名称。&lt;/p>
&lt;p>其他的默认就可以了。然后点击保存并应用。完成后如下图：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/ca5ce0494c7c0868dd10460616318694.png"
loading="lazy"
>&lt;/p>
&lt;p>如上图我添加的子域名是gzax6,那么我还需要去添加一条解析才能使用gzax6.frps.com:7000来访问我的ax6这个路由器的管理界面。&lt;/p>
&lt;p>我们添加一条CNAME的记录，因为ip地址是一直在变化的，我们唯一不变的就是ddns使用的域名，我们解析一条CNAME记录到我们ddns使用的域名，这样子就可以正确的解析到我的openwrt里的frps服务端了。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;p>经过上述步骤，我们就可以使用域名:7000端口来在外网访问我们内网的路由器管理界面了。&lt;/p></description></item><item><title>openwrt配置Cloudflare DDNS</title><link>https://konghanghang.github.io/iminling-pages/2023/openwrt-configuration-cf-ddns/</link><pubDate>Sat, 08 Apr 2023 18:12:20 +0000</pubDate><guid>https://konghanghang.github.io/iminling-pages/2023/openwrt-configuration-cf-ddns/</guid><description>&lt;p>配置DDNS的前提条件是家里的宽带需要有公网ip。下面我们开始使用cloudflare来进行DDNS的配置。&lt;/p>
&lt;h2 id="添加ddns配置">添加ddns配置
&lt;/h2>&lt;p>选择openwrt里的动态DNS功能，然后在里边添加一个自己的配置，名称随便，如我添加的&lt;code>MYDDNS&lt;/code>`。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/1681004803830.jpg"
loading="lazy"
>&lt;/p>
&lt;p>添加后就跳转到了配置界面，首先我们要选择ddns的提供商，这里我们选择cloudflare:&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/71685ba48430ecd770cf4478d066f580.png"
loading="lazy"
>&lt;/p>
&lt;p>切换后如下图：&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/5bccfa93f359096fcbed66be11f03113.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="查询主机名">查询主机名
&lt;/h3>&lt;p>这个就是我们的域名，通过这个域名访问到我们的openwrt管理后台，配置一个自己的三级域名，比如购买的域名的&lt;code>openwrt.com&lt;/code>`。这里则填写&lt;code>admin.openwrt.com&lt;/code>`。&lt;/p>
&lt;h3 id="域名">域名
&lt;/h3>&lt;p>域名这个选项其实就上将查询主机名修改为&lt;code>admin@openwrt.com&lt;/code>。&lt;/p>
&lt;h3 id="用户名和密码">用户名和密码
&lt;/h3>&lt;p>用户名是cloudflare的登录邮箱，密码是cloudflare的global api key。如下图，点击后边的view就可以查看自己的key了。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/9b9dbdfdf83b87c8ecf7c552f7938b04.png"
loading="lazy"
>&lt;/p>
&lt;p>截止上边openwrt里的配置就已经完成了。点击保存并应用就可以了。&lt;/p>
&lt;h2 id="域名解析">域名解析
&lt;/h2>&lt;p>我们在上边使用到了&lt;code>admin.openwrt.com&lt;/code>。然后我们需要在cloudflare的后台去配置这个域名的解析。添加一条A记录，记录值为`admin`,然后我们就可以通过admin.自己的二级域名来访问我们软路由系统了。IPv4地址可以先随便填一个，等待ddns程序自动进行更新。&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/dbaf8d30654b248e86a3942fd7e0ad41.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="开放openwrt端口">开放openwrt端口
&lt;/h2>&lt;p>在openwrt后台系统中找到&lt;code>网络-防火墙-端口转发&lt;/code>`，进行端口转发配置&lt;/p>
&lt;p>具体配置说明：&lt;/p>
&lt;p>名称：随便填一个标识。&lt;/p>
&lt;p>传输协议：选则TCP+UDP。&lt;/p>
&lt;p>外部区域：选wan口&lt;/p>
&lt;p>外部端口：ddns中的域名+外部端口访问到你这个机器。端口一般在1024~65535中选择。&lt;/p>
&lt;p>内部区域：选lan口&lt;/p>
&lt;p>内部ip地址：选openwrt的管理后台ip,例如我这里是192.168.6.1。&lt;/p>
&lt;p>内部端口：openwrt的管理后台一般都是输入ip就可以访问，所以端口是80.&lt;/p>
&lt;p>&lt;img src="https://www.iminling.com/wp-content/uploads/2023/04/81b1d5e9cd4cfd2ad84557fa31f8a401.png"
loading="lazy"
>&lt;/p>
&lt;p>添加，然后保存并应用，就可以通过ddns里的配置的&lt;code>查询域名:外部端口&lt;/code>访问到管理后台，本文中的就是&lt;code>admin.openwrt.com:8080&lt;/code>。8080端口是我随便写的，根据自己情况选择一个可以使用的端口，1024~65535之间的都可以。&lt;/p></description></item></channel></rss>